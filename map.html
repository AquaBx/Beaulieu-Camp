
<head>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100vw;
        }
        textarea {
            width: 205px;
            height: 205px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
</head>

<div id="map"></div>


<script>
var modified = {}
function save2(){
	fetch("./modif.php",{method:"POST", body:JSON.stringify(modified)})
	modified = {}	
}
function change(key,type,value){
	if(!modified[key]){
		modified[key] = {}
	}
	modified[key][type] = value
    console.log(modified)
}

</script>

<script type="module">

var map = L.map('map').setView([48.1192022, -1.6394826], 16);

map.createPane('labels');
map.getPane('labels').style.zIndex = 650;
map.getPane('labels').style.pointerEvents = 'none';


var positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
        attribution: '©OpenStreetMap, ©CartoDB'
}).addTo(map);

var positronLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {
        attribution: '©OpenStreetMap, ©CartoDB',
        pane: 'labels'
}).addTo(map);

var points = await fetch("points.json")
points = await points.json()

for (var point of points){
    var circle = L.circle(point,{radius:0.01,color: "green",fillOpacity: 0.1},1).addTo(map).on("click", create);
}

var polys = await fetch("polygons.json")
polys = await polys.json()

for (var pol of polys){
    let key = polys.indexOf(pol).toString()
    L.polygon(pol[0],{color: "orange",fillOpacity: 0.5}).addTo(map).bindPopup(
		"id: "+key +"<br>"
		+ "location: <textarea onchange=change('"+key+"','0',this.value)>"+JSON.stringify(pol[0]) +"</textarea><br>" 
	    + "name: <input value="+ pol[1] +" onchange=change('"+key+"','1',this.value)></input><br>" 
        + "type: <input value="+ pol[2] +" onchange=change('"+key+"','2',this.value)></input><br>" 
        + "description: <input value="+ pol[3] +" onchange=change('"+key+"','3',this.value)></input><br>" 
        + "image: <input value="+ pol[4] +" onchange=change('"+key+"','4',this.value)></input><br>" 
    ).bindTooltip(pol[1],{permanent: true, direction:"center",fill:false}).openTooltip();
;

}

var poly = []
let polygon = L.polygon(poly,{color: "green",fillOpacity: 0}).addTo(map);

function create(point){
    map.removeLayer(polygon)
    poly.push([point.latlng.lat,point.latlng.lng]);
    polygon = L.polygon(poly,{color: "green",fill: false}).addTo(map).on("contextmenu", save);
}

function save(polyg){
    map.removeLayer(polygon)
    polys.push(poly)
    L.polygon(poly,{color: "orange",fillOpacity: 0.5}).addTo(map);
    console.log(JSON.stringify(polys))
    poly = []
}



</script>
